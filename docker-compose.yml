version: '3.8'

services:
  dashboard:
    build: 
      context: .
      dockerfile: ./web_monitor/Dockerfile
    container_name: home_ai_dashboard
    depends_on:
      - ollama
    restart: always
    ports:
      - "8050:5000" # Maps Jetson 8050 -> Container 5000
    volumes:
      - /var/run/dbus:/var/run/dbus  # Connects container to host system bus
      - /var/run/docker.sock:/var/run/docker.sock # Allows container to interact with host Docker daemon
      - /run/jtop.sock:/run/jtop.sock # Allows jtop library to communicate with host jtop service
      - /home/abrooski/.ssh/abrooski_jetson:/root/.ssh/abrooski_jetson:ro # Mount SSH private key
      - /usr/bin/tegrastats:/usr/bin/tegrastats # Adding tegrastats access
      - /sys:/sys
      - /dev:/dev
    environment: # New section for environment variables
      - SSH_USERNAME=abrooski
      - SSH_PRIVATE_KEY_PATH=/root/.ssh/abrooski_jetson
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  ollama:
      image: ollama/ollama:latest
      container_name: ollama_jetson
      restart: always
      runtime: nvidia
      ports:
        - "11434:11434"
      volumes:
        - ~/.ollama:/root/.ollama
      environment:
        - OLLAMA_KEEP_ALIVE=-1  # Keeps the model loaded indefinitely
      deploy:
        resources:
          reservations:
            devices:
              - driver: nvidia
                count: all
                capabilities: [gpu]

  netdata:
    image: netdata/netdata:latest
    container_name: netdata
    hostname: jetson-monitor
    ports:
      - "19999:19999"
    restart: always
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    pid: host
    volumes:
      - ./netdata/config:/etc/netdata # Local config for exporting
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

  influxdb:
    image: influxdb:latest
    container_name: influxdb
    ports:
      - "8086:8086"
    restart: always
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin
      - DOCKER_INFLUXDB_INIT_ORG=home_ai
      - DOCKER_INFLUXDB_INIT_BUCKET=jetson_metrics
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=home-ai-super-secret-token
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2

  data_analyzer:
    build:
      context: .
      dockerfile: ./data_analyzer/Dockerfile
    container_name: data_analyzer
    restart: always
    ports:
      - "8051:8050" # Map 8051 to internal 8050
    volumes:
      - ./data_analyzer/projects:/app/projects

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    ports:
      - "3000:3000"
    restart: always
    environment:
      - HOMEPAGE_ALLOWED_HOSTS=192.168.1.11,192.168.1.11:3000,192.168.1.16,192.168.1.16:3000,localhost,127.0.0.1
      - LOG_LEVEL=debug
    volumes:
      - ./homepage/config:/app/config
      - ./homepage/images:/app/public/images
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - netdata
      - dashboard

volumes:
  netdatalib:
  netdatacache:
  influxdb_data:
  influxdb_config: